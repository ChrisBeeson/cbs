#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

usage() {
  echo "Usage: cbs-validate-spec [--map-only|--specs-only|--envelopes-only|--architecture-only]"
  echo "Validates CBS specifications, envelopes, generates cell map, and validates app architecture"
}

SPECS=true
ENVELOPES=true
MAP=true
ARCHITECTURE=true

case "${1:-all}" in
  --specs-only) ENVELOPES=false; MAP=false; ARCHITECTURE=false ;;
  --envelopes-only) SPECS=false; MAP=false; ARCHITECTURE=false ;;
  --map-only) SPECS=false; ENVELOPES=false; ARCHITECTURE=false ;;
  --architecture-only) SPECS=false; ENVELOPES=false; MAP=false ;;
  --help|-h) usage; exit 0 ;;
  all) ;;
  *) echo "Unknown option: $1"; usage; exit 1 ;;
esac

echo "üß™ CBS Validation Suite"
echo "======================"

if [ "$SPECS" = true ]; then
  echo "üìã Validating cell specs..."
  "$ROOT_DIR/cbs-agent/scripts/validate_spec.py"
fi

if [ "$ENVELOPES" = true ]; then
  echo
  echo "üì® Validating envelope schemas..."
  "$ROOT_DIR/cbs-agent/scripts/validate_envelopes.sh"
fi

if [ "$MAP" = true ]; then
  echo
  echo "üó∫Ô∏è  Generating cell map..."
  "$ROOT_DIR/cbs-agent/scripts/generate_cell_map.py"
fi

if [ "$ARCHITECTURE" = true ]; then
  echo
  echo "üèóÔ∏è  Validating application architecture..."
  "$ROOT_DIR/cbs-agent/scripts/cbs-validate-architecture" --all
fi

echo
echo "‚úÖ Validation complete"


