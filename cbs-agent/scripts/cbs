#!/usr/bin/env bash
set -euo pipefail

# Unified CBS CLI - single entry point for all CBS development tools
ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

usage() {
  echo "CBS - Cell Body System Development CLI"
  echo "Usage: cbs <command> [args...]"
  echo "Commands:"
  echo "  context <app_name>                    Set application context"
  echo "  focus <cell_name>                     Focus on specific cell"
  echo "  work <app> <cell>                     Start work session on app/cell"
  echo "  validate [--specs|--envelopes|--map|--architecture]  Full validation suite"
  echo "  isolation [--app|--all]               Validate cell isolation"
  echo "  validate-code-isolation [--app|--all] Validate code-level isolation"
  echo "  realtime-feedback [--watch|--app]     Real-time CBS compliance feedback"
  echo "  bus-simulator --app <app> --cell <cell>  Simulate bus interactions"
  echo "  cell <action> [args...]               Cell management (search, install, etc)"
  echo "  app-spec <app>                        Create/update app specification"
  echo "  regenerate-cell <app> <cell>          Regenerate cell from spec"
  echo "  workflow <action> [args...]           Workflow state management"
  echo "  --help, -h                            Show this help"
  echo
  echo "See individual scripts for detailed usage."
}

if [[ $# -eq 0 ]]; then
  usage
  exit 1
fi

cmd="$1"
shift

case "$cmd" in
  context)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-app-context" "$@"
    ;;
  focus)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-cell-focus" "$@"
    ;;
  work)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-work" "$@"
    ;;
  validate)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-validate-spec" "$@"
    ;;
  isolation)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-validate-isolation" "$@"
    ;;
  validate-code-isolation)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-validate-code-isolation" "$@"
    ;;
  realtime-feedback)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-realtime-feedback" "$@"
    ;;
  bus-simulator)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-bus-simulator" "$@"
    ;;
  cell)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-cell" "$@"
    ;;
  app-spec)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-app-spec" "$@"
    ;;
  regenerate-cell)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-regenerate-cell" "$@"
    ;;
  workflow)
    exec "$ROOT_DIR/cbs-agent/scripts/cbs-workflow" "$@"
    ;;
  --help|-h)
    usage
    exit 0
    ;;
  *)
    echo "Unknown command: $cmd"
    usage
    exit 1
    ;;
esac
